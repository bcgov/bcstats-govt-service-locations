---
title: "Technical Documentation"
format:
  html:
    toc: true
    toc-depth: 3
    number-sections: true
    number-depth: 3
    theme: cerulean
    code-fold: true
    grid: 
        body-width: 1800px
        sidebar-width: 100px
        margin-width: 300px
    css: styles.css
    html-math-method: katex
    self-contained: true
---

::: {style="font-size: 0.9em;"}
## Configuration Settings {-}

### settings.R (Global Constants/Configuration) {-}

The file `settings.R` contains the settings for the project, including global constants (written in all caps) and the paths to the data files. These constants are used throughout the project to ensure consistency and simplify configuration.

#### General Project Settings

-   **CSD_NAMES**: A list of municipalities of interest for the analysis (`Langford`, `Dawson Creek`, `Smithers`, `Kamloops`). This constant is used extensively throughout the project to filter data and focus analyses on these specific localities.
-   **CSDIDS**: The numeric census subdivision IDs corresponding to the municipalities in CSD_NAMES.
-   **CENSUS_BASIS**: The census year used for the analysis (2021). This defines which year's data files and statistics are used.
-   **CANCENSUS_YEAR**: The formatted census year string (`CA21`) for use with the `cancensus` package. Automatically constructed from CENSUS_BASIS.
-   **CURRENT_YEAR**: The current analysis year (2025).

#### File and Directory Paths

-   **LAN_FOLDER**: The base folder for the project, configured using the `safepaths::use_network_path()` function. This provides a consistent root directory for all data resources.
-   **SRC_DATA_FOLDER**: The folder containing processed source data files, a subfolder of the LAN_FOLDER. These are intermediate files produced by the pipeline.
-   **RAW_DATA_FOLDER**: The folder containing unprocessed input data files, a subfolder of the LAN_FOLDER.
-   **DT_DATA_FOLDER**: The folder containing raw drive time data collected for the nearest facility analysis (`nearest-facility-BC`).
-   **SBCLOC_FILEPATH**: Path to the file containing Service BC office locations.
-   **SHAPEFILE_OUT**: Destination folder where processed geospatial shapefiles are saved after processing.
-   **MAP_OUT**: Destination folder where map visualizations (PNG, SVG files) are saved for reporting.
-   **VISUALS_OUT**: Base folder for all visualization outputs, including maps and charts.
-   **TABLES_OUT**: Destination folder where tabular outputs like summary statistics are saved.
-   **FOR_SBC_OUT**: Output folder for Service BC-specific outputs.

#### File Naming and Path Patterns

-   **NO_ERRS_FILE_PATTERN**: Regular expression pattern (`no_errors.csv`) used to identify valid drive time files without errors.
-   **INPUT_ADDR_DA_PATTERN**: Pattern (`address_with_da.*`) for identifying address files with dissemination area information.

#### Data Columns and Tags

-   **REQUIRED_COLS**: The required column names in the input data files, including spatial coordinates and drive metrics (`site_albers_x`, `site_albers_y`, `dissemination_block_id`, `drv_time_sec`, `drv_dist`, `tag`).
-   **POP_COLS**: Column names for population-related data (`region_name`, `area_sq_km`, `population`, `dwellings`, `households`).
-   **FACILITY_TAG**: Identifier tag (`servicebc`) used to filter rows related specifically to Service BC locations.

#### Visualization Settings

-   **MAP_THEME**: A predefined ggplot2 theme object for map visualizations, ensuring consistent styling across all maps in the project. Specifies text sizes, positioning, grid appearance, and other aesthetic properties.
-   **BOX_PLOT_THEME**: Theme settings specifically optimized for box plots, including rotated x-axis labels for better readability.
-   **VIOLIN_PLOT_THEME**: Theme settings specifically optimized for violin plots, similar to box plot theme but with specialized settings.
-   **SCATTER_PLOT_THEME**: A variant of BOX_PLOT_THEME, with x-axis text not rotated, for scatter plots.
-   **FILL_THEME**: A predefined scale for continuous color fills using the viridis color palette (`mako` option), with specified alpha transparency and handling for NA values.
-   **FILL_THEME_D**: A similar fill scale but optimized for discrete (categorical) data.
-   **COLOR_THEME_D**: A discrete color scale for line and point colorings using the viridis palette.

#### Project Dependencies

-   The project requires several R packages, including: `safepaths`, `glue`, `tidyverse`, `janitor`, `snakecase`, `ggplot2`, `scales`, `readxl`, `sf`, `bcdata`, `tigris`, `spatstat`, `stars`, `terra`, `fs`, `ggnewscale`, `bcmaps`, `rmapshaper`, and `e1071`. These are loaded in `settings.R` and are required for the scripts to function.
:::

------------------------------------------------------------------------

## Raw to Ready Data {-}

### 00-make-data.R (Data Preprocessing) {-}

The file `00-make-data.R` prepares the data required for subsequent analysis, such as visuals and tables. It reads, transforms, and writes a variety of data sources, effectively creating a project “data lake” on the LAN. The script processes raw input files, generates shapefiles, creates crosswalks, and produces both full-province and municipality-specific (“reduced”) outputs for efficient downstream use.

#### Drive Time Data Preparation

-   Reads the consolidated drive time data file (`final_result_no_errors.csv`) from the LAN, cleans column names, renames key columns for consistency, and derives dissemination area IDs (daid) from dissemination block IDs (dbid).
-   The processed drive time data is saved as `full-processed-drivetime-data.csv` and, after filtering for the municipalities of interest, as `reduced-drivetime-data.csv` in the source data folder.

#### Shapefiles

-   Generates shapefiles for Census Subdivisions (CSDs) and Dissemination Blocks (DBs) using the `bcmaps` and `bcdata` packages.
-   Writes both full-province shapefiles (`full-csd_with_location.gpkg`, `full-db_with_location.gpkg`) and reduced shapefiles for the four municipalities of interest (`reduced-csd-with-location.gpkg`, `reduced-db-with-location.gpkg`) to the shapefile output folder.
-   Additionally, creates exploratory shapefiles for Statistics Canada population centers and FSAs, saved as GeoPackage files for reference.

#### Crosswalks

-   Constructs a correspondence file (`csd-da-db-loc-correspondance.csv`) linking DBs, DAs, and CSDs, including names and types, for all of BC.
-   Builds a crosswalk for only the DBs present in the drive time data, joining with the correspondence file for hierarchical relationships.

#### Population Data

-   Retrieves population data for DBs and CSDs from the `cancensus` package, cleans and selects relevant columns, and writes out as `full-population-db.csv` and `full-population-csd.csv`.
-   Filters and writes reduced population files for the municipalities of interest (`reduced-population-db.csv`, `reduced-population-csd.csv`).
-   **API Key Requirement**: The first time a user runs this script, they will need a CensusMapper API key. Users can obtain a free key by signing up at [CensusMapper](https://censusmapper.ca/). Once obtained, the key should be set using:

``` r
cancensus::set_cancensus_api_key('YOUR_API_KEY', install = TRUE)
```

This will store the key in the user's R environment for future use. API quotas are generally sufficient for standard analysis, but users performing extensive operations may need to request higher limits.

#### Population Projections

-   Downloads CSD-level population projections from BC Data Catalogue, cleans and standardizes region codes.
-   Allocates CSD projections to DBs by calculating the proportion of each DB within its CSD, assuming these proportions remain constant over time.
-   Joins projections to DBs and transforms age columns into rows, creating age groups for analysis.
-   Saves the resulting DB-level projections as `full_db_projections_transformed.rds` and the raw projections as `full-population-projections.csv`.

#### Service BC Location Data

-   Extracts Service BC office locations by joining processed drive time data with the crosswalk, and writes the full and reduced sets as `full-service-bc-locs.csv` and `reduced-service_bc_locs.csv`.
-   Coordinates are stored in the Albers equal-area projection (EPSG:3005).

#### Output Summary

The following key files are produced in the source and shapefile output folders:

-   `full-processed-drivetime-data.csv`, `reduced-drivetime-data.csv`
-   `full-service-bc-locs.csv`, `reduced-service_bc_locs.csv`
-   `csd-da-db-loc-correspondance.csv`
-   `full-population-db.csv`, `reduced-population-db.csv`
-   `full-population-csd.csv`, `reduced-population-csd.csv`
-   `full-population-projections.csv`
-   `full_db_projections_transformed.rds`
-   `full-csd_with_location.gpkg`, `reduced-csd-with-location.gpkg`
-   `full-db_with_location.gpkg`, `reduced-db-with-location.gpkg`
-   Exploratory: `popcenter-statscan.gpkg`, `fsa-statscan.gpkg`

#### Notes

-   The script writes both full-province and reduced (municipality-specific) outputs for efficiency in downstream scripts.
-   The logic for DB-level population projections and age group transformation is implemented directly in the script.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## CSD-level Analysis {-}

### 01a-descriptive-tables.R (Descriptive Statistics) {-}

This script `01-descriptive-tables.R` generates comprehensive statistical summaries of drive times and distances to Service BC offices. The data is aggregated at two distinct geographic levels—Dissemination Block (DB) and Census Subdivision (CSD) to support multi-scale analysis and form the analytical foundation for subsequent visualizations.

#### Data Preparation and Inputs

-   Reads in reduced drive time data (`reduced-drivetime-data.csv`) and population data for DBs and CSDs (`reduced-population-db.csv`, `reduced-population-csd.csv`).
-   Cleans column names and ensures numeric types for relevant fields.

#### Statistical Summaries

-   Uses the `calculate_drivetime_stats()` function to compute summary statistics for drive distance and drive time (in both seconds and minutes), including:
    -   Mean, variance, skewness, kurtosis
    -   Quantiles (min, 25th, median, 75th, max)
    -   Count of distinct addresses per group
-   Summaries are calculated at the DB level (`csd_name`, `csdid`, `dbid`) and CSD level (`csd_name`, `csdid`).
-   Population metrics (area, population, dwellings, households) are joined to the summary tables for context.

#### Data Quality Checks

-   Calculates the proportion of DBs with missing address counts and the proportion with fewer than 5 addresses.
-   Summarizes the number and percentage of DB blocks with low address counts by CSD.

#### Service BC Location Counts

-   Calculates the number of Service BC locations in each CSD, accounting for possible multiple locations per label.

#### Output Files

The following key tables are produced and written to the source and tables output folders:

-   `reduced_db_average_times_dist_all_locs.csv`: DB-level summary statistics (used as input for future scripts)
-   `reduced_csd_average_times_dist_all_locs.csv`: CSD-level summary statistics
-   `reduced_csd_low_counts.csv`: Summary of DB blocks with low address counts by CSD
-   `reduced_csd_service_bc_counts.csv`: Number of Service BC locations per CSD

#### Notes

-   DA-level summaries are not currently produced in this script.
-   The script removes the `csd_name` column from population data before joining, due to naming mismatches.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

### 01b-compare-metrics.R (Drive Time vs Distance) {-}

This script `01b-compare-metrics.R` generates a comparative visualization of driving distance and driving time to the nearest Service BC office at the dissemination block (DB) level. The resulting scatter plot provides insight into the relationship between these two accessibility metrics across the municipalities of interest.

#### Data Preparation and Inputs

-   Reads in DB-level summary statistics from `reduced_db_average_times_dist_all_locs.csv` (produced by the previous script).
-   Cleans column names and ensures numeric types for mean drive distance and mean drive time.

#### Comparative Visualization

-   Creates a scatter plot of mean driving distance (km) versus mean driving time (minutes) for each DB, colored by census subdivision (CSD).
-   Adds a linear regression line for each CSD group to highlight trends.
-   Facets the plot by CSD, allowing for comparison across municipalities.
-   Applies consistent styling using the `SCATTER_PLOT_THEME` and `COLOR_THEME_D` defined in `settings.R`.

#### Output Files

-   The scatter plot is saved as a PNG file in the `csd-drive-distance-plots` subfolder of the `VISUALS_OUT` directory.

#### Notes

-   This visualization helps identify differences in the relationship between distance and time across regions, which may reflect variations in road networks, geography, or traffic conditions.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

### 01c-bin-distances.R (Generate Binned Distances) {-}

This script `01c-bin-distances.R` categorizes and summarizes drive distances to the nearest Service BC office for each municipality. The resulting binned tables provide a clear view of the distribution of address accessibility by distance bands.

#### Data Preparation and Inputs

-   Reads in reduced drive time data from `reduced-drivetime-data.csv`.
-   Cleans column names and ensures numeric types for drive distance and drive time.

#### Binning and Summarization

-   Assigns each record to a drive distance bin:
    -   Under 1 km
    -   1 to 5 km
    -   5 to 10 km
    -   10 to 20 km
    -   20+ km
-   For each municipality (CSD), calculates:
    -   The total number of addresses in each distance bin
    -   The percentage of addresses in each bin (relative to the CSD total)
-   Data is transformed into both long and wide formats for reporting and analysis.

#### Output Files

-   The binned summary table is saved as `reduced-csd-binned-drivetime-data.csv` in the `TABLES_OUT` directory.

#### Notes

-   This summary enables quick comparison of accessibility patterns across municipalities and supports downstream reporting and visualization.
-   The script includes error handling for file loading and ensures the output directory exists before writing results.


## CSD-level Visualizations {-}

### 02a-map-plots.R (Cloropleth Maps) {-}

The script `02a-map-plots.R` generates thematic maps visualizing accessibility metrics at the dissemination block (DB) level for each of the four municipalities of interest. These maps display spatial patterns in mean driving distance to the nearest Service BC office, supporting the identification of geographic disparities in service access.

#### Data Preparation and Inputs

-   Reads in the reduced DB-level shapefile (`reduced-db-with-location.gpkg`).
-   Reads in DB-level summary statistics (`reduced_db_average_times_dist_all_locs.csv`).
-   Reads in Service BC location data (`reduced-service_bc_locs.csv`).
-   Cleans and merges data to ensure all relevant attributes are available for mapping.

#### Map Generation

-   For each municipality in `CSD_NAMES`, generates a separate map of mean driving distance to the nearest Service BC office.
-   Uses the custom `build_map()` function (from `fxns/csd-plots.R`) to:
    -   Filter data for the selected municipality.
    -   Apply consistent cartographic styling (`MAP_THEME`, `FILL_THEME`).
    -   Overlay Service BC locations as reference points.
    -   Handle missing data by highlighting areas with no drive data in red.
-   The variable mapped is currently set to mean driving distance (`drv_dist_mean`), but the function can be adapted for other metrics if needed.

#### Output Files

-   Saves one SVG map per municipality in the `csd-drive-distance-maps` subfolder of the `MAP_OUT` directory. Filenames reflect the mapped variable and region.

#### Notes

-   The script focuses on DB-level mapping for the four municipalities of interest; DA and CSD-level maps are not produced here.
-   DA and CSD shapefiles and DA-level summary statistics are not required for this script.
-   The script clears the R environment at the end to free memory for subsequent processing steps.


### 02b-box-violin-plots.R (Statistical Visualizations) {-}

The `02b-box-violin-plots.R` script generates statistical visualizations that reveal the distribution patterns of mean driving distances to the nearest Service BC office across the four municipalities of interest. These visualizations complement the spatial maps by providing comparative statistical perspectives on accessibility.

#### Data Preparation and Inputs

-   Reads in DB-level summary statistics from `reduced_db_average_times_dist_all_locs.csv` (produced by earlier scripts).
-   Cleans column names and ensures numeric types for relevant fields, including mean driving distance.
-   Filters data to include only the municipalities listed in `CSD_NAMES` (as defined in `settings.R`).

#### Visualization Logic

-   For each municipality, generates:
    -   **Box Plot**: Shows the distribution of mean driving distances by municipality, highlighting central tendency, spread, and outliers.
    -   **Violin Plot**: Illustrates the full distribution shape and density of mean driving distances for each municipality.
-   Both plots use the custom `build_boxplot()` and `build_violinplot()` functions from `fxns/csd-plots.R`, with consistent styling and color scales.
-   Plot parameters (titles, axis labels, themes) are set using constants from `settings.R` (`BOX_PLOT_THEME`, `VIOLIN_PLOT_THEME`, `FILL_THEME_D`).

#### Output Files

-   Saves the box plot as a PNG file in the `csd-drive-distance-plots` subfolder of the `VISUALS_OUT` directory, with a filename indicating the plot type and variable.
-   Saves the violin plot as a separate PNG file in the same directory.

#### Notes

-   The script currently visualizes mean driving distance (`drv_dist_mean`) by municipality. Other metrics can be substituted by adjusting the `y_var` parameter.
-   No summary statistics CSV is produced by this script; outputs are limited to the visualizations.
-   The script clears the R environment at the end to free memory for subsequent processing steps.

### 02c-density-map.R (Smoothed Density Maps) {-}

The `02d-density_map.R` script generates smoothed spatial density maps visualizing drive distances to the nearest Service BC office for each municipality of interest. By applying kernel density estimation, the script produces continuous heatmaps that fill spatial gaps between known address points, providing a more complete representation of accessibility patterns.

#### Data Preparation and Inputs

-   Reads DB-level population data (`reduced-population-db.csv`) and calculates people per household.
-   Reads point-level drive time data (`reduced-drivetime-data.csv`), converts coordinates to spatial features, and joins population data.
-   Reads Service BC location data (`reduced-service_bc_locs.csv`) and converts to spatial features.
-   Reads CSD boundary shapefiles (`full-csd_with_location.gpkg`) for all census subdivisions.
-   Filters and prepares data for each municipality using CSD identifiers.

#### Density Estimation and Map Generation

-   For each municipality (CSD), subsets address points and boundaries.
-   Converts address points to a spatial point pattern (`ppp` object) and assigns drive distance as a mark.
-   Applies kernel density smoothing (`Smooth()` from `spatstat`) with a bandwidth of 1000 meters and a grid resolution of 300x300 cells.
-   Converts the smoothed result to a raster and then to a spatial feature for plotting.
-   Overlays CSD boundaries, address points, and Service BC locations on the map.
-   Supports a toggle for common scale normalization across municipalities (`common_scale` parameter), ensuring either consistent color ranges for comparison or locally optimized ranges for detail.

#### Styling

-   Uses consistent cartographic styling from `settings.R` (`MAP_THEME`, `FILL_THEME`).
-   Service BC locations are rendered as yellow reference markers with standardized symbolization.
-   Map titles, subtitles, and legends are dynamically generated for each municipality.

#### Output Files

-   Saves each map as a PNG file in the `csd-drive-distance-maps` subfolder of the `MAP_OUT` directory. Filenames indicate the mapped variable, scale setting, and municipality.

#### Notes

-   The script focuses on drive distance (`drv_dist`) as the primary metric, but can be adapted for drive time or other variables.
-   Handles missing or empty data gracefully, skipping maps for municipalities with no address points.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

###  02d-csd-demographics.R (Additional Demographic Work) {-}

The `02d-csd-demographics.R` script generates demographic summaries and visualizations for each municipality of interest, focusing on population structure and projections. This script produces both summary tables and population pyramid plots to support demographic analysis at the census subdivision (CSD) level.

#### Data Preparation and Inputs

-   Reads Service BC location data (`reduced-service_bc_locs.csv`) and filters to the municipalities in `CSD_NAMES`.
-   Loads population projections (`full-population-projections.csv`) and census population data (`reduced-population-db.csv`).
-   Reads the crosswalk file (`csd-da-db-loc-correspondance.csv`) to link DBs, DAs, and CSDs.
-   Loads DB-level population projections (`full-db-projections-transformed.rds`) and filters to the CSDs of interest.

#### Demographic Summaries

-   Aggregates DB-level population projections to the CSD level for the current year, calculating:
    -   Estimated total population
    -   Median age (weighted by population)
-   Writes the summary statistics to `reduced-csd_population_metrics.csv` in the `TABLES_OUT` directory.

#### Population Pyramid Visualization

-   Prepares data for population pyramids by joining DB-level projections with CSD assignments.
-   For each municipality, generates a population pyramid plot showing the distribution of population by age group and gender for the current year and projections for 5 and 10 years ahead.
-   Uses the custom `create_population_pyramid()` function from `fxns/csd-plots.R` to create the plots.
-   Saves each CSD’s population pyramid as a PNG file in the `csd_population_pyramids` subfolder of the `MAP_OUT` directory.
-   Optionally creates a combined plot of up to four pyramids for comparative visualization.

#### Output Files

-   `reduced-csd_population_metrics.csv`: CSD-level summary statistics (TABLES_OUT)
-   Individual PNG files for each CSD’s population pyramid (`csd_population_pyramids` folder in MAP_OUT)
-   Combined PNG file with multiple pyramids for side-by-side comparison

#### Notes

-   The script uses age and gender breakdowns from the population projections to provide both current and future demographic perspectives.
-   All plots and tables are generated for the municipalities specified in `CSD_NAMES`.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## SBC-level Analysis {-}

### 03a-create-catchments.R (Catchment Area Delineation) {-}

The script `03a-create-catchments.R` executes the comprehensive assignment of every dissemination block (DB) to a specific service catchment area. It employs a hierarchical methodology, prioritizing empirical drive-time data while utilizing secondary spatial proximity algorithms to ensure 100% geographic coverage across the province.

#### Data Preparation and Inputs

-   Reads Service BC location data (`full-service-bc-locs.csv`) and projects coordinates to the BC Albers (EPSG:3005) coordinate reference system.
-   Loads the processed drive-time matrix (`full-processed-drivetime-data.csv`) and cleans attribute headers for relational consistency.
-   Integrates DB-level population statistics (`full-population-db.csv`) and provincial DB shapefiles (`full-db-with-location.gpkg`).
-   Imports specialized assignment logic from the `calculations.r` function library.

#### Catchment Assignment Logic

-   Utilizes `assign_nearest_facility()` to link DBs to facilities based on the minimum recorded drive-time impedance.
-   For DBs lacking valid routing data (e.g., areas with no address points or topographical errors), the `assign_unassigned_dbs()` function executes a batch-processed Euclidean distance calculation to identify the nearest facility.
-   Generates aggregate catchment boundaries by performing a spatial union of constituent DB geometries, followed by a topological simplification (`ms_simplify`) to optimize file size for administrative reporting.

#### Data Quality and QA Diagnostics

-   Calculates the statistical variance between drive-time and spatial-proximity assignment cohorts, documenting the frequency of "no-route" errors.
-   Summarizes demographic exposure by analyzing population distributions (median, mean, and zero-count frequencies) within unassigned blocks.
-   Maintains a transparent audit trail of the assignment method used for every dissemination block in the provincial set.

#### Output Files

The following key datasets and geospatial artifacts are produced:

-   `complete-db-assignments.csv`: The master crosswalk of all DBs and their assigned facility catchments (Source Data Folder).
-   `complete-db-assignments-for-SBC.csv`: A refined, distinct list of assignments for external stakeholder use (Service BC Output Folder).
-   `sbc-catchments.shp`: A simplified geospatial shapefile representing aggregated facility service areas (Service BC Output Folder).
-   `unassigned_dbs.csv` and `unassigned_dbs_summary.csv`: Detailed QA reports and demographic summaries of routing failures (Tables Output Folder).

#### Notes

-   The script ensures total provincial coverage by falling back to spatial proximity when network-based routing is unavailable.
-   The simplification of the final shapefile geometry is set to a 1% threshold to balance geographic precision with computational performance.
-   The R environment is purged upon script completion to ensure memory availability for subsequent analytical modules.

### 03b-plot-catchments.R (Catchment Area Visualization) {-}

The script `03b-plot-catchments.R` generates a series of cartographic visualizations to illustrate the spatial distribution of Service BC facility catchments. These maps serve as visual evidence of the assignment methodologies—specifically contrasting empirical network-based assignments with direct spatial fill methods—at both the regional pilot and provincial scales.

#### Data Preparation and Inputs

-   Loads provincial boundary data via the `bcmaps` package and transforms geometries to the BC Albers projection (EPSG:3005).
-   Integrates Census Subdivision (CSD) and Dissemination Block (DB) shapefiles from the `SHAPEFILE_OUT` directory.
-   Ingests Service BC location data and the pre-computed assignment ledger (`complete_db_assignments.csv`) generated by the preceding catchment delineation module.
-   Calculates adjusted geometric centroids for pilot municipalities to optimize label placement and prevent overlapping symbology.

#### Map Generation

-   Produces a localized reference map identifying the four primary municipalities of interest, utilizing standardized symbology for Service BC office locations.
-   Renders maps depicting catchments derived exclusively from empirical drive-time data, explicitly highlighting "unassigned" geographic zones in dark gray where routing data is absent.
-   Generates refined visualizations that incorporate both drive-time and direct spatial assignments. This map utilizes alpha-transparency layers to differentiate between primary network-based assignments (higher opacity) and secondary proximity-based fills (lower opacity).
-   *Produces macro-level visualizations of the entire province to evaluate the continuity of service coverage and the spatial extent of facility influence beyond the pilot regions.

#### Optimization and Styling

-   Employs the `rmapshaper::ms_simplify()` algorithm (retaining between 1% and 5% of vertices) to enhance rendering performance and reduce output file size while preserving essential topological features.
-   Applies project-specific themes (`MAP_THEME`) and color scales (`viridis_d` with the 'turbo' palette) to ensure consistent visual interpretation across all reporting artifacts.
-   Implements manual coordinate offsets for label geometries in Dawson Creek and Langford to maintain legibility against complex boundary lines.

#### Output Files

The following visualizations are archived within the `MAP_OUT/complete_catchments` directory:

-   `pilot_regions.png`: A high-level reference map of the analysis focus areas.
-   `pilot_original_catchments.png` and `province_original_catchments.png`: Maps illustrating service gaps in the primary drive-time dataset.
-   `pilot_complete_catchments.png` and `province_complete_catchments.png`: Comprehensive maps displaying 100% geographic assignment across the province.

#### Notes

-   The script relies on pre-computed data from `03a-create-catchments.R` and does not perform any new assignment calculations.
-   Geometry simplification is critical for the provincial-scale maps to prevent excessive memory usage during the `ggsave` process.
-   The R environment is cleared and memory is garbage-collected (`gc()`) upon completion to maintain system stability for the final document rendering.

### 03c-sbc-centric-stats.R (Facility-Centric Performance Metrics) {-}

The script `03c-sbc-centric-stats.R` executes a granular performance and demographic analysis localized to individual Service BC facilities. By pivoting the analytical lens from administrative boundaries to catchment-specific influence zones, the routine quantifies service delivery burden, transit impedance distributions, and longitudinal population shifts unique to each facility’s operational footprint.

#### Data Preparation and Inputs

-   Synthesizes pre-computed catchment assignments (`complete-db-assignments.csv`), processed drive-time matrices, and longitudinal population projections (`full-db-projections-transformed.rds`).
-   Integrates facility coordinates and Dissemination Block (DB) geometries from the provincial shapefile repository (`full-db-with-location.gpkg`).
-   Utilizes a comprehensive correspondence file to bridge DB identifiers with Census Subdivision (CSD) and Dissemination Area (DA) hierarchies, ensuring high-fidelity grouping for Service BC-centric measures.

#### Catchment-Based Metric Computation

-   Computes comprehensive drive-time and distance distributions for each facility, including measures of central tendency (mean, median), dispersion (variance, standard deviation), and extreme values (quantiles, min/max).
-   Estimates total population, weighted average age, and median age within each catchment area. This calculation accounts for the proportional representation of CSDs within a facility’s footprint, utilizing the `pct_of_csd` constant derived from DB-level transformations.
-   Quantifies the percentage of a facility's catchment area derived from empirical drive-time routing versus direct spatial assignment, providing a metric for data reliability and geographic "edge case" identification.

#### Visualization and Statistical Graphics

-   Generates individual and faceted histograms to visualize the frequency of transit distances within catchments, supporting the identification of outlier populations with excessive travel burdens.
-   Produces high-resolution spatial visualizations for each Service BC location, mapping mean driving distances at the DB level to reveal internal accessibility gradients within the catchment boundary.
-   Constructs population pyramids for each facility, illustrating age and gender distributions for the current year alongside five- and ten-year projections to forecast future service demand shifts.
-   *Executes box-plot visualizations to contrast driving distance distributions across the various catchments of interest, facilitating systemic benchmarking of facility accessibility.

#### Output Files

The script produces an extensive catalog of evidentiary artifacts archived within the `TABLE

### 03d-sbc-density-maps.R (Catchment Spatial Density Analysis) {-}

The script `03d-sbc-density-maps.R` executes a sophisticated spatial smoothing routine to visualize accessibility gradients within Service BC facility catchments. By transitioning from discrete address-level data points to a continuous surface via kernel density estimation (KDE), the script identifies localized "service deserts" and geographic trends in drive-time impedance that may be obscured in aggregate statistical reporting.

#### Data Preparation and Inputs

-   Integrates dissemination block (DB) population counts to derive household density, facilitating a nuanced understanding of potential service demand.
-   *Processes empirical drive-time and distance data, converting coordinate pairs into spatial features projected in the BC Albers (EPSG:3005) system.
-   Ingests the complete DB assignment ledger (`complete_db_assignments.csv`) to delineate the spatial boundaries for each facility's analytical window.
-   Loads both DB and Census Subdivision (CSD) geometries to provide administrative context and facilitate spatial filtering.

#### Spatial Smoothing and Mapping Logic

-   Utilizes the `spatstat` package to apply a Gaussian kernel (`Smooth()`) to address-level drive distances. The routine employs a bandwidth ($\sigma$) of 1000 meters and a grid resolution of $300 \times 300$ cells to generate a continuous friction surface.
-   *Converts KDE surfaces into `stars` objects and subsequently into `sf` polygons, ensuring that density estimates are strictly constrained to the legal boundaries of the facility's assigned catchment.
-   Explicitly identifies and renders regions with "No Drive Data Available" in red. These represent areas where network routing failed, and assignments were defaulted to Euclidean proximity, signaling zones of lower data reliability.
-   Supports a toggle for `common_scale` normalization, allowing for either locally optimized color gradients or a standardized provincial scale to facilitate direct inter-facility comparison.

#### Cartographic Styling and Visualization

-   Overlays address-level point data (grey), smoothed density surfaces (mako viridis scale), and facility locations (yellow diamond markers) to provide a multi-scalar view of accessibility.
-   Renders the associated pilot region (CSD) boundary in black to illustrate how facility catchments intersect with or transcend municipal jurisdictions.
-   Adheres to the global `MAP_THEME` while utilizing `ggnewscale` to manage multiple discrete and continuous fill legends within a single visualization.

#### Output Files

The following high-resolution PNG artifacts are archived in the `{MAP_OUT}/sbc-catchment-drive-distance-maps` directory:

-   `catchment-drv_dist-commonscale=[TRUE/FALSE]-[CSD_NAME]-[FACILITY_ID].png`: Detailed heatmaps illustrating the spatial distribution of transit impedance for each facility catchment.

#### Notes

-   The KDE routine utilizes `suppressWarnings` during `ppp` object creation to account for coincident address points (e.g., apartment complexes) which are valid in high-density urban contexts.
-   The script employs `tryCatch` blocks to handle potential failures in spatial smoothing for catchments with sparse data or irregular topologies.
-   To prevent memory fragmentation during the generation of complex spatial rasters, the R environment is purged and garbage-collected (`gc()`) upon the completion of the mapping loop.

## Service BC Specific Analysis {-}

### 04-sbc-servicebc-catchments.R (Administrative Catchment Mapping) {-}

This script creates a provincial map illustrating the service catchments assigned to each municipality based on official administrative records. Unlike previous models that use empirical drive-time data, this script visualizes the "CSD Method" of assignment to provide a baseline for comparing existing administrative boundaries against network-based catchments.

#### Data Preparation and Inputs

-   Loads the BC provincial boundary and Census Subdivision (CSD) geometries, transforming them to the BC Albers projection (EPSG:3005).
-   Reads the reduced Service BC location data to identify office coordinates for the Diamond-shaped markers.
-   Imports the official mapping spreadsheet (`Municipality(CSD)toSBCofficeMappying_updated (1).xlsx`) from the raw data folder to link specific CSD IDs with their assigned office.
-   Joins the Excel-based assignments to the CSD spatial boundaries for mapping.

#### Map Generation

-   Calculates the center points (centroids) of each municipality to determine label placement.
-   Applies specific manual offsets ("nudges") to the labels for Dawson Creek and Langford to prevent overlap with boundary lines and improve legibility.
-   Renders the CSD boundaries colored by their assigned facility using the "turbo" viridis color scale.
-   Overlays the Service BC office locations as yellow diamond markers on top of the BC provincial outline.

#### Output Files

The following visualization is produced and saved in the `complete_catchments` subfolder:

-   `bc-csd-sbc-FROM-SERVICE-BC.png`: A provincial-scale map showing the official administrative office assignments for every municipality.

#### Notes

-   This script is dependent on the external Excel mapping file; any changes to administrative assignments must be updated in the source spreadsheet.
-   The label nudging logic is specific to the current pilot regions; if the project scope expands, additional municipalities may require manual coordinate adjustments.
-   The script clears the R environment and performs a garbage collection (`gc()`) at the end to ensure system memory is available for subsequent tasks.


### 05a-csd-data-tables.R (CSD Statistics and Demographic Profiling) {-}

This script aggregates demographic, geographic, and drive-time data to create a comprehensive statistical profile for each Census Subdivision (CSD) in British Columbia. It combines population projections with spatial analysis to determine how residents across different municipalities access Service BC locations.

#### Data Preparation and Inputs

* Loads geographic crosswalks to align Dissemination Blocks (DBs) with Census Subdivisions (CSDs).
* Imports spatial shapefiles for DBs, CSDs, and Statistics Canada population centers, standardizing all to the BC Albers projection.
* Integrates provincial drive-time data containing over 2 million records to link residential areas to the nearest service facilities.
* Ingests BC Stats population projections and age demographics for current and future year intervals.
* Calculates household size estimates by distributing total CSD populations proportionally across known address locations.

#### Statistical Aggregation and Logic

* Bins the population into specific driving distance categories ranging from under 5 km to over 180 km.
* Categorizes population counts by drive-time intervals, using segments from 5 minutes up to 150+ minutes.
* Calculates mean and median driving distances and times for every municipality to measure service accessibility.
* Develops 5-year and 10-year population growth projections for each CSD to support long-term service planning.
* Segments the population into four primary age brackets and calculates weighted mean and median ages for each jurisdiction.
* Determines the rural status of both residents and Service BC offices by analyzing spatial overlaps with defined population centers.

#### Output Files

The following statistical artifact is produced and saved in the `TABLES_OUT` directory:

* `csd-statistics-for-SBC-[Date].csv`: A master table containing all demographic, rurality, and drive-time metrics indexed by CSD.


### 05b-sbc-data-tables.R (SBC Catchment Area Statistical Profiling) {-}

This script aggregates demographic, rurality, and accessibility metrics for the 65 Service BC (SBC) locations across British Columbia. Unlike the previous script which focused on municipality-level data, this routine compiles statistics based on the total population and area served by each specific SBC office catchment.

#### Data Preparation and Inputs

* Loads the complete database of address-to-office assignments, linking over 52,000 Dissemination Blocks (DBs) to their corresponding service locations.
* Integrates provincial drive-time data to calculate the travel distances and times for all addresses within each office's service area.
* Ingests BC Stats population projections, age demographics, and spatial shapefiles for both municipalities and population centers.
* Standardizes all spatial data to the BC Albers projection (EPSG:3005) to ensure consistent area and distance calculations.
* Calculates an estimated household size per address by dividing the total DB population by the number of known address points.

#### Statistical Aggregation and Logic

* Categorizes the population served by each SBC office into drive-distance bins (ranging from <5 km to 180+ km) and drive-time bins (ranging from <5 minutes to 150+ minutes).
* Calculates specific accessibility metrics for each office, including the total number of addresses served, the number of municipalities within the catchment, and the mean/median travel times and distances.
* Projects catchment population growth for 5-year and 10-year intervals and segments the current population into age brackets (0–14, 15–24, 25–64, and 65+).
* Determines the rural composition of each catchment by identifying residents living outside defined population centers.
* Flags the office locations themselves as "Rural" or "Urban" based on their spatial overlap with Statistics Canada population center boundaries.

#### Output Files

The script generates a master summary table and several supporting reference files in the `FOR_SBC_OUT` directory:

* `sbc-location-statistics-for-SBC-[Date].csv`: A comprehensive master table containing demographic, accessibility, and rurality metrics for all 65 SBC locations.
* `rurality-by-db.csv`: A reference file identifying the urban/rural status of every Dissemination Block.
* `rural-residence-summary.csv`: A summary of rural population counts per office.
* `rural-office.csv`: A list identifying whether each Service BC office is located in a rural area.

#### Notes

* This script uses "household size estimates" to distribute population data across address points, which allows for more granular accessibility reporting than using block centroids alone.
* The "assigned" office for each area is determined by the results of the drive-time optimization model established in previous workflow steps.
* All numeric outputs are rounded to one decimal place for reporting consistency.

## Other Research {-}

### 05c-rural-analysis.R (Urban/Rural Classification Methodology) {-}

This script evaluates and compares different methodologies for classifying residential areas, service catchments, and office locations as "Urban" or "Rural." By testing various spatial definitions, the script establishes a robust framework for understanding service delivery challenges in non-urban environments.

#### Data Preparation and Inputs

* Loads point-level address data and transforms it into spatial features using BC Albers coordinates.
* Imports Statistics Canada Forward Sortation Area (FSA) boundaries to support postal-code-based classification (Method 1).
* Ingests Statistics Canada Population Center boundaries to support geography-based classification (Method 2).
* Integrates Dissemination Block (DB) shapefiles and population projections to allow for population-weighted rurality analysis.
* Accesses the complete office assignment crosswalk to link individual residential classifications back to specific Service BC catchments.

#### Script Logic and Analysis

* Performs a point-in-polygon spatial join to determine if individual addresses reside within a defined population center or a "rural" postal code (FSA starting with 'V0').
* Aggregates point-level classifications to the provincial and catchment levels to calculate the percentage of rural residents served by each office.
* Conducts a population-based analysis by mapping Dissemination Blocks to rural zones, providing an alternative metric to address-count-based classification.
* Compares the outcomes of the FSA method against the Population Center method to identify discrepancies and select the most accurate baseline for BC.
* Classifies the 65 Service BC office locations themselves as urban or rural based on their physical coordinates.
* Generates comparative visualizations, including scatter plots of address-based vs. population-based rurality and provincial maps of classification results.

#### Output Files

The script produces several analytical tables and visualizations stored in the `FOR_SBC_OUT` and `MAP_OUT` directories:

* `catchment_rural_methods_comparison.csv`: A detailed comparison of rurality percentages per office catchment across all tested methods.
* `urban-dbid-popcenter-crosswalk.csv`: A reference file mapping every DB to its associated population center.
* `all-data-urban-rural.png`: A provincial-scale map showing the distribution of urban and rural areas.
* `catchment-urban-rural.png`: A map overlaying Service BC catchment boundaries with rurality classifications.

#### Notes

* The "Population Center" method is generally treated as the primary standard, where any area falling outside a defined center is automatically classified as rural.
* The script identifies that address-based counts can sometimes overstate rurality compared to population-based counts; the provided comparison table helps account for this bias.
* Manual checks are performed for specific locations (e.g., Atlin) to ensure the spatial joins handled remote areas correctly.
* Standardized memory cleanup routines are executed to ensure efficient processing of large spatial datasets.

### 05d-plot-rural-urban.R (Population Center Boundary Visualization) {-}

This script generates high-resolution vector graphics to visualize the spatial relationship between Dissemination Blocks (DBs) and Statistics Canada population centers. It serves as a quality assurance tool to validate how specific neighborhoods and blocks are classified as "Urban" or "Rural" across different regions of British Columbia.

#### Data Preparation and Inputs

* Loads Dissemination Block (DB) shapefiles and transforms them to the BC Albers projection (EPSG:3005).
* Imports the Statistics Canada population center boundaries used as the official urban baseline.
* Reads the pre-calculated rurality results (`rurality-by-db.csv`) to obtain the specific urban/rural status assigned to each block.
* Performs spatial joins to associate the geometric shapes of the blocks with their corresponding population center boundaries.

#### Script Logic and Generation

* Groups the data by population center name to allow for individual analysis of specific towns and cities.
* Utilizes a specialized visualization function (`vis_pc_rural_urban`) to create detailed comparison plots for each location.
* Nests the dataset to iterate through every population center in the province programmatically.
* Renders the classification results into a series of SVG files, which maintain clarity at high zoom levels for boundary inspection.

#### Output Files

The following visualizations are produced and saved in the `rural-method-misc` directory:

* `[Population-Center-Name].svg`: A collection of individual vector map files (one per population center) showing the exact classification of every block within and surrounding the area.

#### Notes

* The script includes a specific workaround for a known `ggplot2` viewport issue to ensure that the grid-based drawings render correctly in the SVG output.
* The output format is set to SVG specifically to support detailed manual review of complex boundaries where standard raster images (like PNG) might lose detail.
* While the script defaults to processing the entire province, it contains internal logic to filter for specific pilot regions (e.g., Duncan, Victoria, Fort St. James) for focused analysis.

## Ad Hoc Work {-}

### 06-quick-centroids-tables.R (Preliminary Pilot Impact and Proximity Analysis) {-}

This script facilitates the expedited generation of a preliminary analytical dataset—specifically commissioned for January administrative review—to assess the spatial implications of integrating a singular pilot service location into the existing Service BC (SBC) infrastructure. The methodology employs a geometric centroid-based proximity model (Euclidean distance) to provide a comparative baseline between the current sixty-five-office configuration and an expanded sixty-six-office scenario (inclusive of the pilot site).

#### Data Preparation and Inputs

* Performs an ingestion of spatial coordinates for the sixty-five (65) extant Service BC facilities and the proposed pilot location, the latter of which requires a formal geographic coordinate transformation (from the WGS 84 datum, EPSG:4326, to the British Columbia Albers projection, EPSG:3005) to ensure spatial consistency across all comparative geometry layers.
* Loads Dissemination Block (DB) geometries, Census Subdivision (CSD) crosswalks, and Statistics Canada population center boundaries to provide the necessary demographic and jurisdictional context for subsequent proximity calculations.
* Integrates longitudinal population projections—aggregated from pre-processed RDS objects—to facilitate service demand forecasting across a ten-year horizon.

#### Proximity Modeling and Catchment Assignment

* Utilizes a centroid-to-centroid assignment logic (executed via the `assign_unassigned_dbs` function), which, while distinct from the high-fidelity road-network travel models used in antecedent scripts, provides an efficient proxy for measuring geographic proximity.
* Calculates the minimum straight-line distance (Euclidean metric) between 52,000+ DB centroids and their nearest service facility under two distinct iterations: a baseline scenario (the original 65 locations) and a pilot scenario (the 65 locations plus the pilot facility).
* Quantifies the resultant shift in service catchments by identifying DBs where the pilot location represents a more proximal service point than the existing infrastructure.

#### Demographic Integration and Rurality Classification

* Aggregates population projections for the current year (2025) and subsequent five- and ten-year intervals (2030 and 2035) to support strategic resource allocation analysis.
* Determines the urban-rural designation for each DB based on a spatial intersection with population center boundaries; following established project parameters, any DB maintaining an area coverage ratio of $\le 30\%$ within a defined population center is classified as "Rural."
* Conducts a spatial validation of catchment reassignments using `ggplot2` to ensure that geographic partitions follow logical proximity gradients within the specific geographic extent of the pilot region.

#### Output Files

The finalized statistical artifact is exported to the `FOR_SBC_OUT` directory:

* `sbc-pilot_statistics-db-centroid-method-[Date].csv`: A comprehensive table containing DB identifiers, CSD names, multi-year population projections, and comparative distance metrics for both the 65-office and 66-office scenarios.

#### Notes

* This script employs Euclidean distance as an optimization for processing speed; users should note that these values do not represent true road-network travel distances and are intended for comparative proximity analysis rather than absolute accessibility modeling.
* The script includes automated directory verification logic to ensure the `FOR_SBC_OUT` path exists prior to file serialization.
* Numeric outputs for distances and population estimates are rounded to one decimal place to maintain reporting consistency across the administrative dataset.

### 07-db-centroid-assignment-standalone.R (Automated Geometric Catchment Modeling) {-}

This script constitutes a self-contained computational pipeline designed for the rapid spatial assignment of Dissemination Blocks (DBs) to Service BC (SBC) facilities and the subsequent aggregation of demographic projections. By automating data acquisition from the British Columbia Data Catalogue (BCDC) and Statistics Canada (via the Cancensus API), the routine facilitates an objective, reproducible analysis of service accessibility based on geometric proximity metrics.

#### Data Preparation and Inputs

* Performs automated retrieval of Dissemination Block geometries and provincial population projections directly from the BCDC API, ensuring that the most recent geographic and demographic frameworks are utilized.
* Executes an API-driven extraction of 2021 Census data (CA21) using the `cancensus` package, requiring a pre-configured CensusMapper API key for the retrieval of DB-level population and dwelling counts.
* Ingests a facility location CSV (EPSG:4326), which is programmatically transformed into the British Columbia Albers projection (EPSG:3005) to maintain spatial alignment with provincial boundary layers.
* Integrates an external rural-urban classification matrix (sourced from the Ministry of Jobs and Economic Growth) to assign categorical rurality labels at the Census Subdivision (CSD) level.

#### Script Logic and Analysis

* Implements a vectorized geometric assignment function (`assign_dbs`) that utilizes the `st_nearest_feature` operation to link individual DB centroids to the nearest SBC facility point based on Euclidean distance.
* Employs a top-down demographic estimation model to convert CSD-level population projections into DB-level estimates; this methodology assumes a static longitudinal proportion of population distribution within each parent jurisdiction.
* Executes a multi-dimensional data "roll-up" to calculate facility-specific metrics, including weighted mean and median age distributions (using `spatstat` weighted calculations) and age-bracketed population counts for the current reporting year.
* Constructs aggregated catchment geometries by performing a spatial union of all DBs assigned to a specific facility, followed by a topological simplification (`ms_simplify`) to optimize rendering performance for geographic information systems (GIS).

#### Output Files

The script generates three primary analytical artifacts within a user-specified output directory:

* `db_centroid_assignments.csv`: A granular list identifying the assigned facility, Euclidean distance (in meters), and demographic projections for every dissemination block.
* `facility_population_projections.csv`: A longitudinal summary of population demographics and age distributions aggregated to the service facility level.
* `facility_catchments/sbc-catchments.shp`: A spatial dataset containing simplified polygonal boundaries representing the geometric service area for each SBC office.

#### Notes

* Users must ensure that the `CM_API_KEY` system environment variable is correctly set via `set_cancensus_api_key()` to avoid authentication failures during the data acquisition phase.
* The proximity modeling is restricted to straight-line Euclidean distance (measured centroid-to-centroid) and does not account for road-network topology, topographical barriers, or seasonal travel variations.
* The "Urban/Rural" designation is derived verbatim from the Rural Initiatives Excel matrix at the CSD level rather than being calculated from local population density or the 30% area-coverage threshold used in previous analytical iterations.

## Future Work

-   Expand the analysis to include additional municipalities and public services.
-   Incorporate socio-economic and demographic factors into the analysis.