---
title: "Technical Documentation"
format:
  html:
    toc: true
    toc-location: right
    toc-depth: 3
    number-sections: false
    theme: cerulean
    code-fold: true
    fig-caption: true
---

::: {style="font-size: 0.9em;"}
## Configuration Settings (settings.R)

The file `settings.R` contains the settings for the project, including global constants (written in all caps) and the paths to the data files. These constants are used throughout the project to ensure consistency and simplify configuration.

#### General Project Settings

-   **CSD_NAMES**: A list of municipalities of interest for the analysis (`Langford`, `Dawson Creek`, `Smithers`, `Kamloops`). This constant is used extensively throughout the project to filter data and focus analyses on these specific localities.
-   **CSDIDS**: The numeric census subdivision IDs corresponding to the municipalities in CSD_NAMES.
-   **CENSUS_BASIS**: The census year used for the analysis (2021). This defines which year's data files and statistics are used.
-   **CANCENSUS_YEAR**: The formatted census year string (`CA21`) for use with the `cancensus` package. Automatically constructed from CENSUS_BASIS.
-   **CURRENT_YEAR**: The current analysis year (2025).

#### File and Directory Paths

-   **LAN_FOLDER**: The base folder for the project, configured using the `safepaths::use_network_path()` function. This provides a consistent root directory for all data resources.
-   **SRC_DATA_FOLDER**: The folder containing processed source data files, a subfolder of the LAN_FOLDER. These are intermediate files produced by the pipeline.
-   **RAW_DATA_FOLDER**: The folder containing unprocessed input data files, a subfolder of the LAN_FOLDER.
-   **DT_DATA_FOLDER**: The folder containing raw drive time data collected for the nearest facility analysis (`nearest-facility-BC`).
-   **SBCLOC_FILEPATH**: Path to the file containing Service BC office locations.
-   **SHAPEFILE_OUT**: Destination folder where processed geospatial shapefiles are saved after processing.
-   **MAP_OUT**: Destination folder where map visualizations (PNG, SVG files) are saved for reporting.
-   **VISUALS_OUT**: Base folder for all visualization outputs, including maps and charts.
-   **TABLES_OUT**: Destination folder where tabular outputs like summary statistics are saved.
-   **FOR_SBC_OUT**: Output folder for Service BC-specific outputs.

#### File Naming and Path Patterns

-   **NO_ERRS_FILE_PATTERN**: Regular expression pattern (`no_errors.csv`) used to identify valid drive time files without errors.
-   **INPUT_ADDR_DA_PATTERN**: Pattern (`address_with_da.*`) for identifying address files with dissemination area information.

#### Data Columns and Tags

-   **REQUIRED_COLS**: The required column names in the input data files, including spatial coordinates and drive metrics (`site_albers_x`, `site_albers_y`, `dissemination_block_id`, `drv_time_sec`, `drv_dist`, `tag`).
-   **POP_COLS**: Column names for population-related data (`region_name`, `area_sq_km`, `population`, `dwellings`, `households`).
-   **FACILITY_TAG**: Identifier tag (`servicebc`) used to filter rows related specifically to Service BC locations.

#### Visualization Settings

-   **MAP_THEME**: A predefined ggplot2 theme object for map visualizations, ensuring consistent styling across all maps in the project. Specifies text sizes, positioning, grid appearance, and other aesthetic properties.
-   **BOX_PLOT_THEME**: Theme settings specifically optimized for box plots, including rotated x-axis labels for better readability.
-   **VIOLIN_PLOT_THEME**: Theme settings specifically optimized for violin plots, similar to box plot theme but with specialized settings.
-   **SCATTER_PLOT_THEME**: A variant of BOX_PLOT_THEME, with x-axis text not rotated, for scatter plots.
-   **FILL_THEME**: A predefined scale for continuous color fills using the viridis color palette (`mako` option), with specified alpha transparency and handling for NA values.
-   **FILL_THEME_D**: A similar fill scale but optimized for discrete (categorical) data.
-   **COLOR_THEME_D**: A discrete color scale for line and point colorings using the viridis palette.

#### Project Dependencies

-   The project requires several R packages, including: `safepaths`, `glue`, `tidyverse`, `janitor`, `snakecase`, `ggplot2`, `scales`, `readxl`, `sf`, `bcdata`, `tigris`, `spatstat`, `stars`, `terra`, `fs`, `ggnewscale`, `bcmaps`, `rmapshaper`, and `e1071`. These are loaded in `settings.R` and are required for the scripts to function.
:::

------------------------------------------------------------------------

## Raw to Ready Data (00-make-data.R)

The file `00-make-data.R` prepares the data required for subsequent analysis, such as visuals and tables. It reads, transforms, and writes a variety of data sources, effectively creating a project “data lake” on the LAN. The script processes raw input files, generates shapefiles, creates crosswalks, and produces both full-province and municipality-specific (“reduced”) outputs for efficient downstream use.

#### Drive Time Data Preparation

-   Reads the consolidated drive time data file (`final_result_no_errors.csv`) from the LAN, cleans column names, renames key columns for consistency, and derives dissemination area IDs (daid) from dissemination block IDs (dbid).
-   The processed drive time data is saved as `full-processed-drivetime-data.csv` and, after filtering for the municipalities of interest, as `reduced-drivetime-data.csv` in the source data folder.

#### Shapefiles

-   Generates shapefiles for Census Subdivisions (CSDs) and Dissemination Blocks (DBs) using the `bcmaps` and `bcdata` packages.
-   Writes both full-province shapefiles (`full-csd_with_location.gpkg`, `full-db_with_location.gpkg`) and reduced shapefiles for the four municipalities of interest (`reduced-csd-with-location.gpkg`, `reduced-db-with-location.gpkg`) to the shapefile output folder.
-   Additionally, creates exploratory shapefiles for Statistics Canada population centers and FSAs, saved as GeoPackage files for reference.

#### Crosswalks

-   Constructs a correspondence file (`csd-da-db-loc-correspondance.csv`) linking DBs, DAs, and CSDs, including names and types, for all of BC.
-   Builds a crosswalk for only the DBs present in the drive time data, joining with the correspondence file for hierarchical relationships.

#### Population Data

-   Retrieves population data for DBs and CSDs from the `cancensus` package, cleans and selects relevant columns, and writes out as `full-population-db.csv` and `full-population-csd.csv`.
-   Filters and writes reduced population files for the municipalities of interest (`reduced-population-db.csv`, `reduced-population-csd.csv`).
-   **API Key Requirement**: The first time a user runs this script, they will need a CensusMapper API key. Users can obtain a free key by signing up at [CensusMapper](https://censusmapper.ca/). Once obtained, the key should be set using:

``` r
cancensus::set_cancensus_api_key('YOUR_API_KEY', install = TRUE)
```

This will store the key in the user's R environment for future use. API quotas are generally sufficient for standard analysis, but users performing extensive operations may need to request higher limits.

#### Population Projections

-   Downloads CSD-level population projections from BC Data Catalogue, cleans and standardizes region codes.
-   Allocates CSD projections to DBs by calculating the proportion of each DB within its CSD, assuming these proportions remain constant over time.
-   Joins projections to DBs and transforms age columns into rows, creating age groups for analysis.
-   Saves the resulting DB-level projections as `full_db_projections_transformed.rds` and the raw projections as `full-population-projections.csv`.

#### Service BC Location Data

-   Extracts Service BC office locations by joining processed drive time data with the crosswalk, and writes the full and reduced sets as `full-service-bc-locs.csv` and `reduced-service_bc_locs.csv`.
-   Coordinates are stored in the Albers equal-area projection (EPSG:3005).

#### Output Summary

The following key files are produced in the source and shapefile output folders:

-   `full-processed-drivetime-data.csv`, `reduced-drivetime-data.csv`
-   `full-service-bc-locs.csv`, `reduced-service_bc_locs.csv`
-   `csd-da-db-loc-correspondance.csv`
-   `full-population-db.csv`, `reduced-population-db.csv`
-   `full-population-csd.csv`, `reduced-population-csd.csv`
-   `full-population-projections.csv`
-   `full_db_projections_transformed.rds`
-   `full-csd_with_location.gpkg`, `reduced-csd-with-location.gpkg`
-   `full-db_with_location.gpkg`, `reduced-db-with-location.gpkg`
-   Exploratory: `popcenter-statscan.gpkg`, `fsa-statscan.gpkg`

#### Notes

-   The script writes both full-province and reduced (municipality-specific) outputs for efficiency in downstream scripts.
-   The logic for DB-level population projections and age group transformation is implemented directly in the script.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## Descriptive Tables (01-descriptive-tables.R)

This script `01-descriptive-tables.R` generates comprehensive statistical summaries of drive times and distances to Service BC offices. The data is aggregated at two distinct geographic levels—Dissemination Block (DB) and Census Subdivision (CSD) to support multi-scale analysis and form the analytical foundation for subsequent visualizations.

#### Data Preparation and Inputs

-   Reads in reduced drive time data (`reduced-drivetime-data.csv`) and population data for DBs and CSDs (`reduced-population-db.csv`, `reduced-population-csd.csv`).
-   Cleans column names and ensures numeric types for relevant fields.

#### Statistical Summaries

-   Uses the `calculate_drivetime_stats()` function to compute summary statistics for drive distance and drive time (in both seconds and minutes), including:
    -   Mean, variance, skewness, kurtosis
    -   Quantiles (min, 25th, median, 75th, max)
    -   Count of distinct addresses per group
-   Summaries are calculated at the DB level (`csd_name`, `csdid`, `dbid`) and CSD level (`csd_name`, `csdid`).
-   Population metrics (area, population, dwellings, households) are joined to the summary tables for context.

#### Data Quality Checks

-   Calculates the proportion of DBs with missing address counts and the proportion with fewer than 5 addresses.
-   Summarizes the number and percentage of DB blocks with low address counts by CSD.

#### Service BC Location Counts

-   Calculates the number of Service BC locations in each CSD, accounting for possible multiple locations per label.

#### Output Files

The following key tables are produced and written to the source and tables output folders:

-   `reduced_db_average_times_dist_all_locs.csv`: DB-level summary statistics (used as input for future scripts)
-   `reduced_csd_average_times_dist_all_locs.csv`: CSD-level summary statistics
-   `reduced_csd_low_counts.csv`: Summary of DB blocks with low address counts by CSD
-   `reduced_csd_service_bc_counts.csv`: Number of Service BC locations per CSD

#### Notes

-   DA-level summaries are not currently produced in this script.
-   The script removes the `csd_name` column from population data before joining, due to naming mismatches.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## Comparing Drive Time and Distance (01b-compare-metrics.R)

This script `01b-compare-metrics.R` generates a comparative visualization of driving distance and driving time to the nearest Service BC office at the dissemination block (DB) level. The resulting scatter plot provides insight into the relationship between these two accessibility metrics across the municipalities of interest.

#### Data Preparation and Inputs

-   Reads in DB-level summary statistics from `reduced_db_average_times_dist_all_locs.csv` (produced by the previous script).
-   Cleans column names and ensures numeric types for mean drive distance and mean drive time.

#### Comparative Visualization

-   Creates a scatter plot of mean driving distance (km) versus mean driving time (minutes) for each DB, colored by census subdivision (CSD).
-   Adds a linear regression line for each CSD group to highlight trends.
-   Facets the plot by CSD, allowing for comparison across municipalities.
-   Applies consistent styling using the `SCATTER_PLOT_THEME` and `COLOR_THEME_D` defined in `settings.R`.

#### Output Files

-   The scatter plot is saved as a PNG file in the `csd-drive-distance-plots` subfolder of the `VISUALS_OUT` directory.

#### Notes

-   This visualization helps identify differences in the relationship between distance and time across regions, which may reflect variations in road networks, geography, or traffic conditions.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## Binned Drive Distance Summaries (01c-bin-distances.R)

This script `01c-bin-distances.R` categorizes and summarizes drive distances to the nearest Service BC office for each municipality. The resulting binned tables provide a clear view of the distribution of address accessibility by distance bands.

#### Data Preparation and Inputs

-   Reads in reduced drive time data from `reduced-drivetime-data.csv`.
-   Cleans column names and ensures numeric types for drive distance and drive time.

#### Binning and Summarization

-   Assigns each record to a drive distance bin:
    -   Under 1 km
    -   1 to 5 km
    -   5 to 10 km
    -   10 to 20 km
    -   20+ km
-   For each municipality (CSD), calculates:
    -   The total number of addresses in each distance bin
    -   The percentage of addresses in each bin (relative to the CSD total)
-   Data is transformed into both long and wide formats for reporting and analysis.

#### Output Files

-   The binned summary table is saved as `reduced-csd-binned-drivetime-data.csv` in the `TABLES_OUT` directory.

#### Notes

-   This summary enables quick comparison of accessibility patterns across municipalities and supports downstream reporting and visualization.
-   The script includes error handling for file loading and ensures the output directory exists before writing results.


## Thematic Maps for Accessibility Metrics
### Standard Choropleth Maps (02a-map-plots.R)

The script `02a-map-plots.R` generates thematic maps visualizing accessibility metrics at the dissemination block (DB) level for each of the four municipalities of interest. These maps display spatial patterns in mean driving distance to the nearest Service BC office, supporting the identification of geographic disparities in service access.

#### Data Preparation and Inputs

-   Reads in the reduced DB-level shapefile (`reduced-db-with-location.gpkg`).
-   Reads in DB-level summary statistics (`reduced_db_average_times_dist_all_locs.csv`).
-   Reads in Service BC location data (`reduced-service_bc_locs.csv`).
-   Cleans and merges data to ensure all relevant attributes are available for mapping.

#### Map Generation

-   For each municipality in `CSD_NAMES`, generates a separate map of mean driving distance to the nearest Service BC office.
-   Uses the custom `build_map()` function (from `fxns/csd-plots.R`) to:
    -   Filter data for the selected municipality.
    -   Apply consistent cartographic styling (`MAP_THEME`, `FILL_THEME`).
    -   Overlay Service BC locations as reference points.
    -   Handle missing data by highlighting areas with no drive data in red.
-   The variable mapped is currently set to mean driving distance (`drv_dist_mean`), but the function can be adapted for other metrics if needed.

#### Output Files

-   Saves one SVG map per municipality in the `csd-drive-distance-maps` subfolder of the `MAP_OUT` directory. Filenames reflect the mapped variable and region.

#### Notes

-   The script focuses on DB-level mapping for the four municipalities of interest; DA and CSD-level maps are not produced here.
-   DA and CSD shapefiles and DA-level summary statistics are not required for this script.
-   The script clears the R environment at the end to free memory for subsequent processing steps.


### Statistical Visualizations (02b-box-violin-plots.R)

The `02b-box-violin-plots.R` script generates statistical visualizations that reveal the distribution patterns of mean driving distances to the nearest Service BC office across the four municipalities of interest. These visualizations complement the spatial maps by providing comparative statistical perspectives on accessibility.

#### Data Preparation and Inputs

-   Reads in DB-level summary statistics from `reduced_db_average_times_dist_all_locs.csv` (produced by earlier scripts).
-   Cleans column names and ensures numeric types for relevant fields, including mean driving distance.
-   Filters data to include only the municipalities listed in `CSD_NAMES` (as defined in `settings.R`).

#### Visualization Logic

-   For each municipality, generates:
    -   **Box Plot**: Shows the distribution of mean driving distances by municipality, highlighting central tendency, spread, and outliers.
    -   **Violin Plot**: Illustrates the full distribution shape and density of mean driving distances for each municipality.
-   Both plots use the custom `build_boxplot()` and `build_violinplot()` functions from `fxns/csd-plots.R`, with consistent styling and color scales.
-   Plot parameters (titles, axis labels, themes) are set using constants from `settings.R` (`BOX_PLOT_THEME`, `VIOLIN_PLOT_THEME`, `FILL_THEME_D`).

#### Output Files

-   Saves the box plot as a PNG file in the `csd-drive-distance-plots` subfolder of the `VISUALS_OUT` directory, with a filename indicating the plot type and variable.
-   Saves the violin plot as a separate PNG file in the same directory.

#### Notes

-   The script currently visualizes mean driving distance (`drv_dist_mean`) by municipality. Other metrics can be substituted by adjusting the `y_var` parameter.
-   No summary statistics CSV is produced by this script; outputs are limited to the visualizations.
-   The script clears the R environment at the end to free memory for subsequent processing steps.

### Smoothed Density Maps (02c-density-map.R)

The `02d-density_map.R` script generates smoothed spatial density maps visualizing drive distances to the nearest Service BC office for each municipality of interest. By applying kernel density estimation, the script produces continuous heatmaps that fill spatial gaps between known address points, providing a more complete representation of accessibility patterns.

#### Data Preparation and Inputs

-   Reads DB-level population data (`reduced-population-db.csv`) and calculates people per household.
-   Reads point-level drive time data (`reduced-drivetime-data.csv`), converts coordinates to spatial features, and joins population data.
-   Reads Service BC location data (`reduced-service_bc_locs.csv`) and converts to spatial features.
-   Reads CSD boundary shapefiles (`full-csd_with_location.gpkg`) for all census subdivisions.
-   Filters and prepares data for each municipality using CSD identifiers.

#### Density Estimation and Map Generation

-   For each municipality (CSD), subsets address points and boundaries.
-   Converts address points to a spatial point pattern (`ppp` object) and assigns drive distance as a mark.
-   Applies kernel density smoothing (`Smooth()` from `spatstat`) with a bandwidth of 1000 meters and a grid resolution of 300x300 cells.
-   Converts the smoothed result to a raster and then to a spatial feature for plotting.
-   Overlays CSD boundaries, address points, and Service BC locations on the map.
-   Supports a toggle for common scale normalization across municipalities (`common_scale` parameter), ensuring either consistent color ranges for comparison or locally optimized ranges for detail.

#### Styling

-   Uses consistent cartographic styling from `settings.R` (`MAP_THEME`, `FILL_THEME`).
-   Service BC locations are rendered as yellow reference markers with standardized symbolization.
-   Map titles, subtitles, and legends are dynamically generated for each municipality.

#### Output Files

-   Saves each map as a PNG file in the `csd-drive-distance-maps` subfolder of the `MAP_OUT` directory. Filenames indicate the mapped variable, scale setting, and municipality.

#### Notes

-   The script focuses on drive distance (`drv_dist`) as the primary metric, but can be adapted for drive time or other variables.
-   Handles missing or empty data gracefully, skipping maps for municipalities with no address points.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## Demographic Summaries and Population Pyramids (02d-csd-demographics.R)

The `02d-csd-demographics.R` script generates demographic summaries and visualizations for each municipality of interest, focusing on population structure and projections. This script produces both summary tables and population pyramid plots to support demographic analysis at the census subdivision (CSD) level.

#### Data Preparation and Inputs

-   Reads Service BC location data (`reduced-service_bc_locs.csv`) and filters to the municipalities in `CSD_NAMES`.
-   Loads population projections (`full-population-projections.csv`) and census population data (`reduced-population-db.csv`).
-   Reads the crosswalk file (`csd-da-db-loc-correspondance.csv`) to link DBs, DAs, and CSDs.
-   Loads DB-level population projections (`full-db-projections-transformed.rds`) and filters to the CSDs of interest.

#### Demographic Summaries

-   Aggregates DB-level population projections to the CSD level for the current year, calculating:
    -   Estimated total population
    -   Median age (weighted by population)
-   Writes the summary statistics to `reduced-csd_population_metrics.csv` in the `TABLES_OUT` directory.

#### Population Pyramid Visualization

-   Prepares data for population pyramids by joining DB-level projections with CSD assignments.
-   For each municipality, generates a population pyramid plot showing the distribution of population by age group and gender for the current year and projections for 5 and 10 years ahead.
-   Uses the custom `create_population_pyramid()` function from `fxns/csd-plots.R` to create the plots.
-   Saves each CSD’s population pyramid as a PNG file in the `csd_population_pyramids` subfolder of the `MAP_OUT` directory.
-   Optionally creates a combined plot of up to four pyramids for comparative visualization.

#### Output Files

-   `reduced-csd_population_metrics.csv`: CSD-level summary statistics (TABLES_OUT)
-   Individual PNG files for each CSD’s population pyramid (`csd_population_pyramids` folder in MAP_OUT)
-   Combined PNG file with multiple pyramids for side-by-side comparison

#### Notes

-   The script uses age and gender breakdowns from the population projections to provide both current and future demographic perspectives.
-   All plots and tables are generated for the municipalities specified in `CSD_NAMES`.
-   At the end of the script, the R environment is cleared to free memory for subsequent processing steps.

## Future Work

-   Expand the analysis to include additional municipalities and public services.
-   Incorporate socio-economic and demographic factors into the analysis.